@model Sector_13_Welfare_Society___Digital_Management_System.Models.Service
@{
    ViewData["Title"] = "Book " + Model.Name;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="page-title-box">
                <h4 class="page-title">Book @Model.Name</h4>
                <div class="page-title-right">
                    <ol class="breadcrumb m-0">
                        <li class="breadcrumb-item"><a href="/">Home</a></li>
                        <li class="breadcrumb-item"><a href="@Url.Action("Index", "Booking")">Book Services</a></li>
                        <li class="breadcrumb-item active">@Model.Name</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body">
                    <h3 class="text-primary mb-3">@Model.Name</h3>
                    
                    @if (!string.IsNullOrEmpty(Model.Description))
                    {
                        <div class="service-description mb-4">
                            <p>@Model.Description</p>
                        </div>
                    }

                    <div class="service-info mb-4">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Service Type:</strong> @Model.ServiceType
                            </div>
                            <div class="col-md-6">
                                <strong>Pricing Type:</strong> Dynamic
                            </div>
                        </div>
                        @if (Model.BasePrice.HasValue)
                        {
                            <div class="row mt-2">
                                <div class="col-md-6">
                                    <strong>Base Price:</strong> @Model.Currency @Model.BasePrice.Value.ToString("F2")
                                </div>
                            </div>
                        }
                    </div>

                    <form id="serviceBookingForm">
                        <input type="hidden" id="serviceId" value="@Model.Id" />
                        <input type="hidden" id="serviceType" value="@Model.ServiceType" />
                        <input type="hidden" id="pricingType" value="Dynamic" />

                        @if (Model.ServiceType?.ToLower() == "bsci")
                        {
                            <div class="bsci-pricing-section">
                                <h5 class="text-primary mb-3">BSCI Audit Configuration</h5>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="workforceSize" class="form-label">Workforce Size *</label>
                                            <input type="number" class="form-control" id="workforceSize" name="workforceSize" 
                                                   min="1" required placeholder="Enter number of workers">
                                            <div class="form-text">Number of workers in your facility</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="location" class="form-label">Location *</label>
                                            <select class="form-select" id="location" name="location" required>
                                                <option value="">Select Location</option>
                                                <option value="Inside Dhaka">Inside Dhaka</option>
                                                <option value="Outside Dhaka">Outside Dhaka</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="pricing-breakdown" id="pricingBreakdown" style="display: none;">
                                    <h6 class="text-success mb-3">Pricing Breakdown</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <tbody>
                                                <tr>
                                                    <td>Man-Days Required:</td>
                                                    <td id="manDaysRequired" class="text-end">-</td>
                                                </tr>
                                                <tr>
                                                    <td>Man-Day Rate (@Model.Currency):</td>
                                                    @* <td id="manDayRate" class="text-end">@Model.ManDayRate?.ToString("F2")</td> *@
                                                </tr>
                                                <tr>
                                                    <td>Audit Fee:</td>
                                                    <td id="auditFee" class="text-end">-</td>
                                                </tr>
                                                <tr>
                                                    <td>Travel Allowance:</td>
                                                    <td id="travelAllowance" class="text-end">-</td>
                                                </tr>
                                                <tr>
                                                    <td>Subtotal:</td>
                                                    <td id="subtotal" class="text-end">-</td>
                                                </tr>
                                                <tr>
                                                    <td>VAT (15%):</td>
                                                    <td id="vatAmount" class="text-end">-</td>
                                                </tr>
                                                <tr class="table-success">
                                                    <td><strong>Total Amount:</strong></td>
                                                    <td id="totalAmount" class="text-end"><strong>-</strong></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="mb-3">
                                <label for="quantity" class="form-label">Quantity</label>
                                <input type="number" class="form-control" id="quantity" name="quantity" 
                                       min="1" value="1" placeholder="Enter quantity">
                            </div>
                        }

                        <div class="d-flex justify-content-between align-items-center mt-4">
                            <a href="@Url.Action("Index", "Booking")" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-1"></i> Back to Services
                            </a>
                            
                            <button type="button" class="btn btn-primary" id="addToCartBtn" disabled>
                                <i class="fas fa-shopping-cart me-1"></i> Add to Cart
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Service Details</h5>
                    
                    <div class="service-details">
                        <div class="mb-3">
                            <strong>Category:</strong><br>
                            @* <span class="text-muted">@Model.ServiceCategory?.Name</span> *@
                        </div>
                        
                        <div class="mb-3">
                            <strong>Service Type:</strong><br>
                            <span class="text-muted">@Model.ServiceType</span>
                        </div>
                        
                        <div class="mb-3">
                            <strong>Pricing Model:</strong><br>
                            <span class="text-muted">Dynamic</span>
                        </div>
                        
                        @if (Model.ServiceType?.ToLower() == "bsci")
                        {
                            <div class="mb-3">
                                <strong>Man-Day Rate:</strong><br>
                            @*     <span class="text-muted">@Model.Currency @Model.ManDayRate?.ToString("F2")</span> *@
                            </div>
                            
                            <div class="mb-3">
                                <strong>Travel Allowance:</strong><br>
                                <span class="text-muted">
                                 @*    Inside Dhaka: @Model.Currency @Model.InsideDhakaTravelAllowance?.ToString("F2")<br>
                                    Outside Dhaka: @Model.Currency @Model.OutsideDhakaTravelAllowance?.ToString("F2") *@
                                </span>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-body">
                    <h6 class="card-title">Need Help?</h6>
                    <p class="text-muted small">
                        Contact our team for assistance with service selection and pricing.
                    </p>
                    <a href="/Contact" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-phone me-1"></i> Contact Us
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const serviceId = document.getElementById('serviceId').value;
    const pricingType = document.getElementById('pricingType').value;
    const addToCartBtn = document.getElementById('addToCartBtn');
    const pricingBreakdown = document.getElementById('pricingBreakdown');
    
    let currentCalculation = null;

    // BSCI specific event listeners
    if (pricingType.toLowerCase() === 'bsci') {
        const workforceSizeInput = document.getElementById('workforceSize');
        const locationSelect = document.getElementById('location');
        
        function calculateBSCIPrice() {
            const workforceSize = parseInt(workforceSizeInput.value);
            const location = locationSelect.value;
            
            if (workforceSize > 0 && location) {
                fetch('@Url.Action("CalculatePrice", "Booking")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        serviceId: parseInt(serviceId),
                        quantity: 1,
                        workforceSize: workforceSize,
                        location: location
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        currentCalculation = data.calculation;
                        updatePricingDisplay(data.calculation);
                        addToCartBtn.disabled = false;
                    } else {
                        console.error('Price calculation failed:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            } else {
                addToCartBtn.disabled = true;
                pricingBreakdown.style.display = 'none';
            }
        }
        
        workforceSizeInput.addEventListener('input', calculateBSCIPrice);
        locationSelect.addEventListener('change', calculateBSCIPrice);
    } else {
        // For non-BSCI services, enable add to cart immediately
        addToCartBtn.disabled = false;
    }
    
    function updatePricingDisplay(calculation) {
        document.getElementById('manDaysRequired').textContent = calculation.manDaysRequired || '-';
        document.getElementById('auditFee').textContent = calculation.auditFee ? calculation.currency + ' ' + calculation.auditFee.toFixed(2) : '-';
        document.getElementById('travelAllowance').textContent = calculation.travelAllowance ? calculation.currency + ' ' + calculation.travelAllowance.toFixed(2) : '-';
        document.getElementById('subtotal').textContent = calculation.subtotal ? calculation.currency + ' ' + calculation.subtotal.toFixed(2) : '-';
        document.getElementById('vatAmount').textContent = calculation.vatAmount ? calculation.currency + ' ' + calculation.vatAmount.toFixed(2) : '-';
        document.getElementById('totalAmount').innerHTML = '<strong>' + calculation.currency + ' ' + calculation.totalAmount.toFixed(2) + '</strong>';
        
        pricingBreakdown.style.display = 'block';
    }
    
    // Add to cart functionality
    addToCartBtn.addEventListener('click', function() {
        if (currentCalculation || pricingType.toLowerCase() !== 'bsci') {
            // Store the service selection in session storage or redirect to checkout
            const serviceData = {
                serviceId: parseInt(serviceId),
                quantity: pricingType.toLowerCase() === 'bsci' ? 1 : parseInt(document.getElementById('quantity').value),
                workforceSize: pricingType.toLowerCase() === 'bsci' ? parseInt(document.getElementById('workforceSize').value) : null,
                location: pricingType.toLowerCase() === 'bsci' ? document.getElementById('location').value : null,
                calculation: currentCalculation
            };
            
            // For now, redirect to checkout with parameters
            const params = new URLSearchParams();
            params.append('serviceIds', serviceData.serviceId);
            params.append('quantities', serviceData.quantity);
            if (serviceData.workforceSize) params.append('workforceSizes', serviceData.workforceSize);
            if (serviceData.location) params.append('locations', serviceData.location);
            
            window.location.href = '@Url.Action("Checkout", "Booking")' + '?' + params.toString();
        }
    });
});
</script>


